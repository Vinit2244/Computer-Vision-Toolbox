# Faster RCNN Visualization Implementation

This document outlines the changes made to implement the visualization requirements for understanding Faster RCNN as specified in the assignment.

## Files Created

1. **visualization.py**
   - Contains the `FasterRCNNVisualizer` class that handles all visualization tasks
   - Implements methods for visualizing objectness maps, object proposals, anchor assignments, and ROI predictions
   - Includes functionality to create animations from the visualizations

2. **train_with_visualization.py**
   - Modified version of the original `train.py` with added visualization capabilities
   - Implements a custom `FasterRCNNWithVisualization` class that wraps the original model
   - Uses hooks to capture intermediate outputs from the RPN and ROI heads
   - Visualizes the model's behavior on a fixed validation batch at regular intervals

3. **run_visualizations.py**
   - Script to run the training with different hyperparameter sets
   - Creates modified config files for each hyperparameter set
   - Runs the training script with each config file

## Visualization Features Implemented

### 1. RPN Visualizations

#### Objectness Map Visualization
- Visualizes the evolution of objectness score heatmaps for every feature map level
- Creates heatmaps showing the probability of an object being present at each location
- Saves images at regular intervals during training to create an animation

#### Object Proposals Visualization
- Visualizes the bounding box proposals generated by the RPN
- Shows how these proposals change over iterations during training
- Creates an animation showing the evolution of proposals

#### Anchor Assignments Visualization
- Visualizes positive anchors (green) and negative anchors (red) during RPN training
- Shows a subset of all anchors (light gray) for reference
- Limits the number of anchors displayed to avoid cluttering

### 2. ROI Head Visualizations

#### ROI Predictions Visualization
- Visualizes the difference between RPN proposals and final bounding box predictions
- Shows RPN proposals in blue and final predictions in green
- Displays classification scores on top of the final predictions
- Creates an animation showing how predictions improve over time

## How to Run the Code

### Prerequisites

Make sure you have all the required dependencies installed:

```bash
pip install -r requirements.txt
```

### Running with Different Hyperparameter Sets

To run the training with the three predefined hyperparameter sets:

```bash
python run_visualizations.py --config config/st.yaml --vis-interval 50 --num-epochs 5
```

This will:
1. Create three different config files with different hyperparameter sets
2. Run the training for each config file
3. Generate visualizations at regular intervals
4. Create animations from the visualizations

### Parameters

- `--config`: Path to the base config file (default: 'config/st.yaml')
- `--vis-interval`: Interval for visualization in steps (default: 50)
- `--num-epochs`: Number of epochs to train for (default: 5)

### Running with a Single Hyperparameter Set

If you want to run with a single hyperparameter set:

```bash
python train_with_visualization.py --config config/st.yaml --vis-interval 50
```

## Hyperparameter Sets

The code runs with three different hyperparameter sets to observe their effects on the model:

1. **Default Values**
   - RPN Foreground IoU Threshold: 0.7
   - RPN Background IoU Threshold: 0.3
   - RPN Batch Size: 256
   - RPN Positive Fraction: 0.5
   - ROI Batch Size: 128
   - ROI Positive Fraction: 0.25

2. **Higher IoU Thresholds**
   - RPN Foreground IoU Threshold: 0.8
   - RPN Background IoU Threshold: 0.4
   - RPN Batch Size: 256
   - RPN Positive Fraction: 0.5
   - ROI Batch Size: 128
   - ROI Positive Fraction: 0.25

3. **Different Batch Sizes and Positive Fractions**
   - RPN Foreground IoU Threshold: 0.7
   - RPN Background IoU Threshold: 0.3
   - RPN Batch Size: 512
   - RPN Positive Fraction: 0.3
   - ROI Batch Size: 256
   - ROI Positive Fraction: 0.4

## Output Structure

The visualizations are saved in the following directory structure:

```
visualizations/
├── [hyperparams_name]/
│   ├── objectness_maps/
│   │   ├── img_0/
│   │   │   ├── level_0_iter_1.png
│   │   │   ├── level_0_iter_2.png
│   │   │   └── ...
│   │   ├── img_0_level_0_animation.mp4
│   │   └── ...
│   ├── object_proposals/
│   │   ├── img_0/
│   │   │   ├── iter_1.png
│   │   │   ├── iter_2.png
│   │   │   └── ...
│   │   ├── img_0_animation.mp4
│   │   └── ...
│   ├── anchor_assignments/
│   │   ├── img_0/
│   │   │   ├── iter_1.png
│   │   │   ├── iter_2.png
│   │   │   └── ...
│   │   ├── img_0_animation.mp4
│   │   └── ...
│   └── roi_predictions/
│       ├── img_0/
│       │   ├── iter_1.png
│       │   ├── iter_2.png
│       │   └── ...
│       ├── img_0_animation.mp4
│       └── ...
```

Where `[hyperparams_name]` is a string representing the hyperparameters used for that run.

## Understanding the Visualizations

### Objectness Maps
- Brighter regions indicate higher probability of an object being present
- The evolution of these maps shows how the RPN learns to identify potential object locations

### Object Proposals
- Red boxes show the proposals generated by the RPN
- The evolution shows how proposals become more focused on actual objects over time

### Anchor Assignments
- Green boxes are positive anchors (high IoU with ground truth)
- Red boxes are negative anchors (low IoU with ground truth)
- Light gray boxes show a subset of all anchors

### ROI Predictions
- Blue boxes show the proposals from the RPN
- Green boxes show the final predictions from the ROI head
- The text shows the classification score for each prediction
- The evolution shows how the final predictions improve over time 